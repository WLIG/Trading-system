# 合约交易模块集成设计

## 概述

本文档描述了在现有量化交易系统基础上集成合约交易功能的设计方案。合约交易（期货交易）相比现货交易具有杠杆效应、双向交易、保证金制度等特点，需要专门的风险管理和策略设计。

## 合约交易基础概念

### 1. 合约类型
- **永续合约**：无到期日的合约，通过资金费率机制维持价格锚定
- **交割合约**：有固定到期日的合约，到期时进行现金交割
- **币本位合约**：以数字货币作为保证金和结算货币
- **USDT本位合约**：以USDT作为保证金和结算货币

### 2. 关键参数
- **杠杆倍数**：放大交易资金的倍数，常见1x-125x
- **保证金**：开仓所需的资金，分为初始保证金和维持保证金
- **强制平仓**：当保证金不足时系统自动平仓
- **资金费率**：永续合约的定期费用，用于维持价格锚定

### 3. 风险特点
- **杠杆风险**：收益和损失都被放大
- **强平风险**：价格波动可能导致强制平仓
- **资金费率风险**：持仓成本可能较高
- **流动性风险**：市场深度不足时的滑点风险

## 系统架构设计

### 1. 模块结构
```
contracts/
├── __init__.py
├── models/
│   ├── __init__.py
│   ├── contract.py          # 合约信息模型
│   ├── position.py          # 持仓模型
│   ├── order.py            # 订单模型
│   └── margin.py           # 保证金模型
├── exchanges/
│   ├── __init__.py
│   ├── base.py             # 交易所基类
│   ├── binance_futures.py  # 币安合约接口
│   └── okx_futures.py      # OKX合约接口
├── strategies/
│   ├── __init__.py
│   ├── base_strategy.py    # 合约策略基类
│   ├── trend_following.py  # 趋势跟踪策略
│   ├── mean_reversion.py   # 均值回归策略
│   ├── arbitrage.py        # 套利策略
│   └── grid_trading.py     # 网格交易策略
├── risk_management/
│   ├── __init__.py
│   ├── position_sizing.py  # 仓位管理
│   ├── stop_loss.py        # 止损管理
│   └── margin_monitor.py   # 保证金监控
└── utils/
    ├── __init__.py
    ├── calculator.py       # 合约计算工具
    └── indicators.py       # 技术指标
```

### 2. 数据库设计

#### 合约信息表 (contracts)
```sql
CREATE TABLE contracts (
    id SERIAL PRIMARY KEY,
    symbol VARCHAR(50) NOT NULL,           -- 合约代码
    base_asset VARCHAR(20) NOT NULL,       -- 基础资产
    quote_asset VARCHAR(20) NOT NULL,      -- 计价资产
    contract_type VARCHAR(20) NOT NULL,    -- 合约类型 (perpetual/delivery)
    contract_size DECIMAL(20,8),           -- 合约面值
    tick_size DECIMAL(20,8),               -- 最小价格变动
    min_qty DECIMAL(20,8),                 -- 最小下单量
    max_leverage INTEGER,                  -- 最大杠杆
    margin_asset VARCHAR(20),              -- 保证金资产
    settlement_asset VARCHAR(20),          -- 结算资产
    expiry_date TIMESTAMP,                 -- 到期日期
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 持仓表 (positions)
```sql
CREATE TABLE positions (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    symbol VARCHAR(50) NOT NULL,
    side VARCHAR(10) NOT NULL,             -- LONG/SHORT
    size DECIMAL(20,8) NOT NULL,           -- 持仓数量
    entry_price DECIMAL(20,8),             -- 开仓价格
    mark_price DECIMAL(20,8),              -- 标记价格
    liquidation_price DECIMAL(20,8),       -- 强平价格
    margin DECIMAL(20,8),                  -- 保证金
    unrealized_pnl DECIMAL(20,8),          -- 未实现盈亏
    leverage INTEGER,                      -- 杠杆倍数
    margin_mode VARCHAR(20),               -- 保证金模式 (isolated/cross)
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 合约订单表 (contract_orders)
```sql
CREATE TABLE contract_orders (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    symbol VARCHAR(50) NOT NULL,
    order_id VARCHAR(100) UNIQUE,          -- 交易所订单ID
    client_order_id VARCHAR(100),          -- 客户端订单ID
    side VARCHAR(10) NOT NULL,             -- BUY/SELL
    position_side VARCHAR(10),             -- LONG/SHORT/BOTH
    type VARCHAR(20) NOT NULL,             -- MARKET/LIMIT/STOP等
    quantity DECIMAL(20,8) NOT NULL,
    price DECIMAL(20,8),
    stop_price DECIMAL(20,8),
    time_in_force VARCHAR(10),             -- GTC/IOC/FOK
    reduce_only BOOLEAN DEFAULT FALSE,
    close_position BOOLEAN DEFAULT FALSE,
    status VARCHAR(20) NOT NULL,           -- NEW/FILLED/CANCELED等
    filled_qty DECIMAL(20,8) DEFAULT 0,
    avg_price DECIMAL(20,8),
    commission DECIMAL(20,8),
    commission_asset VARCHAR(20),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 3. API接口设计

#### 合约信息接口
```python
# 获取合约列表
GET /api/v1/contracts
# 获取合约详情
GET /api/v1/contracts/{symbol}
# 获取合约价格
GET /api/v1/contracts/{symbol}/price
# 获取合约深度
GET /api/v1/contracts/{symbol}/depth
```

#### 账户接口
```python
# 获取合约账户信息
GET /api/v1/contracts/account
# 获取持仓信息
GET /api/v1/contracts/positions
# 获取保证金信息
GET /api/v1/contracts/margin
```

#### 交易接口
```python
# 下单
POST /api/v1/contracts/orders
# 撤单
DELETE /api/v1/contracts/orders/{orderId}
# 获取订单
GET /api/v1/contracts/orders
# 获取交易历史
GET /api/v1/contracts/trades
```

## 核心功能实现

### 1. 交易所接口封装

合约交易需要对接多个交易所的合约API，每个交易所的接口规范和参数都有所不同。我们需要创建统一的接口封装，屏蔽底层差异。

### 2. 风险管理系统

合约交易的风险管理比现货交易更加复杂，需要实时监控保证金水平、计算强平价格、管理杠杆倍数等。

### 3. 仓位管理

合约交易支持双向持仓，需要精确计算持仓成本、未实现盈亏、保证金占用等指标。

### 4. 订单管理

合约交易支持多种订单类型，包括市价单、限价单、止损单、止盈单等，需要完善的订单管理系统。

## 技术实现要点

### 1. 实时数据处理
- WebSocket连接获取实时价格和深度数据
- 实时计算持仓盈亏和保证金水平
- 实时监控强平风险

### 2. 精确计算
- 使用Decimal类型避免浮点数精度问题
- 严格按照交易所规则计算手续费和资金费率
- 精确计算强平价格和保证金要求

### 3. 异常处理
- 网络异常重连机制
- 订单状态同步机制
- 数据一致性保证

### 4. 性能优化
- 数据库连接池管理
- 缓存热点数据
- 异步处理非关键任务

## 安全考虑

### 1. API安全
- API密钥加密存储
- 请求签名验证
- IP白名单限制

### 2. 风险控制
- 最大杠杆限制
- 单笔订单金额限制
- 日交易次数限制
- 强制止损机制

### 3. 数据安全
- 敏感数据加密
- 操作日志记录
- 权限分级管理

## 监控和告警

### 1. 系统监控
- API调用成功率
- 订单执行延迟
- 数据同步状态
- 系统资源使用

### 2. 业务监控
- 持仓风险水平
- 保证金使用率
- 策略执行状态
- 盈亏统计

### 3. 告警机制
- 强平风险告警
- 系统异常告警
- 策略异常告警
- 资金异常告警

## 集成计划

### 第一阶段：基础框架
1. 创建合约交易模块结构
2. 实现数据库模型
3. 封装交易所API接口
4. 实现基础的CRUD操作

### 第二阶段：核心功能
1. 实现订单管理系统
2. 实现持仓管理系统
3. 实现风险管理系统
4. 实现实时数据处理

### 第三阶段：策略集成
1. 实现合约策略基类
2. 集成经典合约策略
3. 实现策略回测功能
4. 实现策略实盘交易

### 第四阶段：完善优化
1. 性能优化
2. 安全加固
3. 监控完善
4. 文档更新

这个设计方案为合约交易模块的集成提供了完整的技术框架，确保系统能够安全、稳定地支持合约交易功能。

